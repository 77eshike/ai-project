// src/components/chat/ChatTabBase.js
import React, { useState, useCallback, useRef, useEffect } from 'react';
import { useKnowledge } from '../../contexts/KnowledgeContext'; // ä¿®å¤è·¯å¾„
import LoadingIndicator from './LoadingIndicator'; // å¯¼å…¥ç»„ä»¶
import ConnectionIndicator from './ConnectionIndicator'; // å¯¼å…¥ç»„ä»¶
import MessageItem from './MessageItem'; // å¯¼å…¥ç»„ä»¶
import KnowledgeSaveModal from './KnowledgeSaveModal'; // å¯¼å…¥ç»„ä»¶

// åˆ é™¤å†…è”çš„å­ç»„ä»¶å®šä¹‰ï¼ˆå› ä¸ºå®ƒä»¬ç°åœ¨åœ¨å•ç‹¬çš„æ–‡ä»¶ä¸­ï¼‰
// åªä¿ç•™ä¸»ç»„ä»¶é€»è¾‘

const ChatTabBase = ({ 
  user,
  voiceEnabled, 
  toggleVoice,
  platformProps = {},
  isMobile = false,
  className = ""
}) => {
  const { addKnowledge } = useKnowledge();
  
  const [chatMessages, setChatMessages] = useState([
    { 
      type: 'ai', 
      content: 'æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„AIåŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®åŠ©æ‚¨ç®¡ç†é¡¹ç›®ã€è§£ç­”é—®é¢˜æˆ–æä¾›åˆ›æ„å»ºè®®ã€‚è¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„ï¼Ÿ', 
      time: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }),
      saved: false,
      id: Date.now()
    }
  ]);
  
  const [chatInput, setChatInput] = useState('');
  const [isSending, setIsSending] = useState(false);
  const [connectionStatus, setConnectionStatus] = useState('connected');
  const [savingMessage, setSavingMessage] = useState(null);
  
  const inputRef = useRef(null);
  const messagesEndRef = useRef(null);
  const buttonRef = useRef(null);

  // ä»å¹³å°ç‰¹å®špropsè·å–è¯­éŸ³ç›¸å…³çŠ¶æ€å’Œæ–¹æ³•
  const {
    voiceState = {},
    voiceError = null,
    onToggleVoiceInput = () => {},
    onClearVoiceError = () => {},
    onMobileQuickTest = () => {},
    speakText = () => {},
    platformUI = null,
    debugInfo = null,
    // ç§»åŠ¨ç«¯ç‰¹æœ‰çš„äº‹ä»¶å’ŒçŠ¶æ€
    onTouchStart = null,
    onTouchEnd = null,
    onTouchCancel = null,
    isPressing = false
  } = platformProps;

  // æ»šåŠ¨åˆ°åº•éƒ¨
  const scrollToBottom = useCallback(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, []);

  useEffect(() => {
    scrollToBottom();
  }, [chatMessages, scrollToBottom]);

  // æ—¶é—´æ ¼å¼åŒ–
  const formatMessageTime = useCallback((time) => {
    if (!time) return new Date().toLocaleTimeString('zh-CN');
    if (time instanceof Date) {
      return time.toLocaleTimeString('zh-CN', { 
        hour: '2-digit', 
        minute: '2-digit'
      });
    }
    return time;
  }, []);

  // ä¿å­˜çŸ¥è¯†ç‚¹
  const handleSaveAsKnowledge = useCallback((message) => {
    setSavingMessage(message);
  }, []);

  const handleKnowledgeSave = useCallback((knowledgeData) => {
    addKnowledge(knowledgeData);
    setChatMessages(prev => prev.map(msg =>
      msg.id === savingMessage.id ? { ...msg, saved: true } : msg
    ));
    setSavingMessage(null);
  }, [addKnowledge, savingMessage]);

  // å‘é€æ¶ˆæ¯
  const handleSendMessage = useCallback(async () => {
    if (!chatInput.trim() || isSending) return;
    
    const cleanInput = chatInput.replace(/\.\.\.$/, '').replace(/ğŸ¤$/, '').trim();
    if (!cleanInput) return;
    
    const userMessage = {
      type: 'user',
      content: cleanInput,
      time: formatMessageTime(new Date()),
      saved: false,
      id: Date.now()
    };
    
    setChatMessages(prev => [...prev, userMessage]);
    setChatInput('');
    setIsSending(true);
    
    try {
      // æ¨¡æ‹ŸAIå“åº”å»¶è¿Ÿ
      await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 2000));
      
      const aiResponses = [
        `æˆ‘å·²ç»æ”¶åˆ°æ‚¨çš„æ¶ˆæ¯ï¼š"${cleanInput}"ã€‚è¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿå›å¤ï¼Œå®é™…åº”ç”¨ä¸­ä¼šè°ƒç”¨çœŸå®çš„AI APIã€‚`,
        `å…³äº"${cleanInput}"ï¼Œæˆ‘å¯ä»¥ä¸ºæ‚¨æä¾›ä»¥ä¸‹å»ºè®®ï¼šé¦–å…ˆéœ€è¦æ˜ç¡®å…·ä½“éœ€æ±‚ï¼Œç„¶ååˆ†æå¯èƒ½çš„æ–¹æ³•ã€‚`,
        `æ„Ÿè°¢æ‚¨çš„æé—®ï¼${cleanInput}è¿™ä¸ªé—®é¢˜å¾ˆæœ‰æ„ä¹‰ï¼Œè®©æˆ‘æ¥è¯¦ç»†è§£é‡Šä¸€ä¸‹ã€‚`,
        `æˆ‘ç†è§£æ‚¨å¯¹"${cleanInput}"çš„å…³æ³¨ï¼Œæ ¹æ®æˆ‘çš„åˆ†æï¼Œæœ‰ä»¥ä¸‹å‡ ç‚¹éœ€è¦è€ƒè™‘ã€‚`
      ];
      
      const aiMessage = {
        type: 'ai',
        content: aiResponses[Math.floor(Math.random() * aiResponses.length)],
        time: formatMessageTime(new Date()),
        saved: false,
        id: Date.now() + 1
      };
      
      setChatMessages(prev => [...prev, aiMessage]);
      
      // è¯­éŸ³å›å¤ï¼ˆç”±å¹³å°æ§åˆ¶ï¼‰
      if (voiceEnabled) {
        speakText(aiMessage.content);
      }
    } catch (error) {
      console.error('å‘é€æ¶ˆæ¯é”™è¯¯:', error);
      
      const errorMessage = {
        type: 'ai',
        content: `æŠ±æ­‰ï¼Œå¤„ç†æ‚¨çš„è¯·æ±‚æ—¶å‡ºç°äº†é—®é¢˜ï¼š${error.message}`,
        time: formatMessageTime(new Date()),
        isError: true,
        id: Date.now() + 1
      };
      
      setChatMessages(prev => [...prev, errorMessage]);
    } finally {
      setIsSending(false);
    }
  }, [chatInput, isSending, voiceEnabled, speakText, formatMessageTime]);

  const handleKeyPress = useCallback((e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSendMessage();
    }
  }, [handleSendMessage]);

  const handleClearChat = useCallback(() => {
    setChatMessages([{
      type: 'ai', 
      content: 'èŠå¤©è®°å½•å·²æ¸…ç©ºã€‚è¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„ï¼Ÿ', 
      time: formatMessageTime(new Date()),
      saved: false,
      id: Date.now()
    }]);
  }, [formatMessageTime]);

  // è¯­éŸ³è¾“å…¥æŒ‰é’®äº‹ä»¶å¤„ç†ï¼ˆæ”¯æŒç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶ï¼‰
  const handleVoiceButtonInteraction = useCallback(async (e) => {
    if (isMobile) return; // ç§»åŠ¨ç«¯ä½¿ç”¨è§¦æ‘¸äº‹ä»¶ï¼Œä¸å¤„ç†ç‚¹å‡»
    
    e.preventDefault();
    e.stopPropagation();
    
    if (voiceState.isListening) {
      onToggleVoiceInput();
    } else {
      await onToggleVoiceInput();
    }
  }, [isMobile, voiceState.isListening, onToggleVoiceInput]);

  // ç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶å¤„ç†
  const handleTouchEvents = useCallback(async (e) => {
    if (!isMobile) return;
    
    e.preventDefault();
    e.stopPropagation();
    
    switch (e.type) {
      case 'touchstart':
        console.log('ç§»åŠ¨ç«¯è§¦æ‘¸å¼€å§‹');
        try {
          await onTouchStart?.(e);
          
          // ç§»åŠ¨ç«¯é¢å¤–å¤„ç†ï¼šæ˜¾ç¤ºåˆå§‹åŒ–çŠ¶æ€
          setTimeout(() => {
            if (voiceState.waitingForPermission) {
              console.log('ç§»åŠ¨ç«¯ä»åœ¨ç­‰å¾…æƒé™ç¡®è®¤...');
            }
          }, 1000);
        } catch (error) {
          console.error('ç§»åŠ¨ç«¯è§¦æ‘¸å¼€å§‹é”™è¯¯:', error);
        }
        break;
        
      case 'touchend':
      case 'touchcancel':
        console.log('ç§»åŠ¨ç«¯è§¦æ‘¸ç»“æŸ');
        try {
          onTouchEnd?.(e);
          
          // ç§»åŠ¨ç«¯è§¦æ‘¸ç»“æŸåçš„å°å»¶è¿Ÿï¼Œç¡®ä¿è¯†åˆ«å®Œæˆ
          setTimeout(() => {
            if (voiceState.isListening) {
              console.log('ç§»åŠ¨ç«¯è¯­éŸ³è¯†åˆ«ä»åœ¨è¿›è¡Œä¸­...');
            }
          }, 500);
        } catch (error) {
          console.error('ç§»åŠ¨ç«¯è§¦æ‘¸ç»“æŸé”™è¯¯:', error);
        }
        break;
    }
  }, [isMobile, onTouchStart, onTouchEnd, onTouchCancel, voiceState]);

  // æ·»åŠ ç§»åŠ¨ç«¯è¯­éŸ³è¯†åˆ«çŠ¶æ€ç›‘æ§
  useEffect(() => {
    if (!isMobile) return;
    
    // ç›‘æ§è¯­éŸ³è¯†åˆ«çŠ¶æ€å˜åŒ–
    if (voiceState.isListening) {
      console.log('ç§»åŠ¨ç«¯è¯­éŸ³è¯†åˆ«å·²å¯åŠ¨');
      
      // ç§»åŠ¨ç«¯ï¼šå¦‚æœ5ç§’åä»åœ¨è†å¬ä½†æ²¡æœ‰ç»“æœï¼Œæç¤ºç”¨æˆ·
      const timeoutId = setTimeout(() => {
        if (voiceState.isListening && !voiceState.transcript) {
          console.log('ç§»åŠ¨ç«¯ï¼šæœªæ£€æµ‹åˆ°è¯­éŸ³è¾“å…¥ï¼Œè¯·æ£€æŸ¥éº¦å…‹é£');
        }
      }, 5000);
      
      return () => clearTimeout(timeoutId);
    }
  }, [isMobile, voiceState.isListening, voiceState.transcript]);

  // æ¶ˆæ¯å…ƒç´ æ¸²æŸ“
  const messageElements = chatMessages.map((message) => (
    <MessageItem 
      key={message.id}
      message={message}
      voiceEnabled={voiceEnabled} 
      onSpeak={speakText}
      onSaveAsKnowledge={handleSaveAsKnowledge}
      isMobile={isMobile}
    />
  ));

  return (
    <div className={`bg-white shadow rounded-lg overflow-hidden h-full flex flex-col ${className}`}>
      <div className="px-4 py-5 sm:p-6 flex-1 flex flex-col min-h-0">
        <div className="flex justify-between items-center mb-4">
          <h3 className="text-lg font-medium text-gray-900">AIåŠ©æ‰‹å¯¹è¯</h3>
          <div className="flex items-center space-x-4">
            <ConnectionIndicator status={connectionStatus} />
            <button
              onClick={handleClearChat}
              className="text-sm text-gray-600 hover:text-gray-800 transition-colors"
              title="æ¸…ç©ºèŠå¤©è®°å½•"
            >
              æ¸…ç©ºè®°å½•
            </button>
            <div className="flex items-center">
              <span className="text-sm text-gray-600 mr-2">è¯­éŸ³æ’­æŠ¥</span>
              <label className="relative inline-flex items-center cursor-pointer">
                <input 
                  type="checkbox" 
                  className="sr-only" 
                  checked={voiceEnabled}
                  onChange={(e) => toggleVoice(e.target.checked)}
                />
                <div className={`w-11 h-6 bg-gray-200 rounded-full transition-colors ${voiceEnabled ? 'bg-blue-600' : ''}`}></div>
                <div className={`absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-transform ${voiceEnabled ? 'transform translate-x-5' : ''}`}></div>
              </label>
            </div>
          </div>
        </div>
        
        {/* å¹³å°ç‰¹å®šUI */}
        {platformUI}
        
        {/* æ¶ˆæ¯åŒºåŸŸ */}
        <div className="border rounded-lg flex-1 overflow-y-auto p-4 mb-4 bg-gray-50 min-h-[300px]">
          <div className="space-y-4">
            {messageElements}
            {isSending && <LoadingIndicator />}
            <div ref={messagesEndRef} />
          </div>
        </div>
        
        {/* è¾“å…¥åŒºåŸŸ */}
        <div className="flex space-x-2">
          <div className="flex-1 relative">
            <input
              ref={inputRef}
              type="text"
              value={chatInput}
              onChange={(e) => setChatInput(e.target.value)}
              onKeyPress={handleKeyPress}
              placeholder={
                voiceState.isListening ? "æ­£åœ¨è¯­éŸ³è¾“å…¥..." : 
                isMobile ? "è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–é•¿æŒ‰éº¦å…‹é£ä½¿ç”¨è¯­éŸ³è¾“å…¥..." :
                "è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–éœ€æ±‚..."
              }
              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 pr-12"
              disabled={isSending}
            />
            
            {/* è¯­éŸ³è¾“å…¥æŒ‰é’® - æ”¯æŒç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶ */}
            {voiceState.isSupported && (
              <button
                ref={buttonRef}
                onClick={isMobile ? undefined : handleVoiceButtonInteraction}
                onTouchStart={isMobile ? handleTouchEvents : undefined}
                onTouchEnd={isMobile ? handleTouchEvents : undefined}
                onTouchCancel={isMobile ? handleTouchEvents : undefined}
                disabled={isSending || voiceState.status === 'starting' || voiceState.status === 'stopping' || voiceState.waitingForPermission}
                className={`absolute right-2 top-1/2 transform -translate-y-1/2 p-2 rounded-full transition-all ${
                  voiceState.isListening 
                    ? 'bg-red-100 text-red-600 border-2 border-red-300 animate-pulse' 
                    : voiceState.waitingForPermission
                    ? 'bg-yellow-100 text-yellow-600 border-2 border-yellow-300 animate-pulse'
                    : isPressing
                    ? 'bg-blue-100 text-blue-600 border-2 border-blue-300'
                    : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                } ${
                  voiceState.status === 'starting' || voiceState.status === 'stopping' || voiceState.waitingForPermission
                    ? 'opacity-50 cursor-not-allowed' 
                    : 'cursor-pointer'
                }`}
                type="button"
                title={
                  isMobile ? (
                    voiceState.waitingForPermission ? 'ç­‰å¾…æƒé™ç¡®è®¤...' :
                    voiceState.isListening ? 'æ¾å¼€ç»“æŸå½•éŸ³' : 
                    voiceState.status === 'starting' ? 'è¯­éŸ³è¯†åˆ«å¯åŠ¨ä¸­...' :
                    'é•¿æŒ‰å¼€å§‹è¯´è¯'
                  ) : (
                    voiceState.waitingForPermission ? 'ç­‰å¾…æƒé™ç¡®è®¤...' :
                    voiceState.isListening ? 'ç‚¹å‡»åœæ­¢è¯­éŸ³è¾“å…¥' : 
                    voiceState.status === 'starting' ? 'è¯­éŸ³è¯†åˆ«å¯åŠ¨ä¸­...' :
                    voiceState.status === 'stopping' ? 'æ­£åœ¨åœæ­¢...' :
                    'ç‚¹å‡»å¼€å§‹è¯­éŸ³è¾“å…¥'
                  )
                }
                style={{ 
                  touchAction: isMobile ? 'none' : 'auto',
                  minWidth: '44px',
                  minHeight: '44px',
                  userSelect: 'none',
                  WebkitUserSelect: 'none'
                }}
              >
                {voiceState.waitingForPermission ? 'ğŸŸ¡' :
                 voiceState.isListening ? 'ğŸ”´' : 
                 voiceState.status === 'starting' ? 'â³' :
                 isPressing ? 'ğŸ”µ' :
                 'ğŸ¤'}
              </button>
            )}
          </div>
          <button
            onClick={handleSendMessage}
            disabled={isSending || !chatInput.trim()}
            className="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
          >
            {isSending ? 'å‘é€ä¸­...' : 'å‘é€'}
          </button>
        </div>

        {/* æŒ‰å‹çŠ¶æ€æŒ‡ç¤ºï¼ˆç§»åŠ¨ç«¯ç‰¹æœ‰ï¼‰ */}
        {isMobile && isPressing && !voiceState.isListening && (
          <div className="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg">
            <div className="flex items-center text-blue-700">
              <div className="flex space-x-1 mr-3">
                <div className="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
                <div className="w-2 h-2 bg-blue-500 rounded-full animate-pulse" style={{animationDelay: '0.2s'}}></div>
                <div className="w-2 h-2 bg-blue-500 rounded-full animate-pulse" style={{animationDelay: '0.4s'}}></div>
              </div>
              <span className="text-sm font-medium">å‡†å¤‡ä¸­...è¯·ç»§ç»­é•¿æŒ‰</span>
            </div>
          </div>
        )}

        {/* è¯­éŸ³çŠ¶æ€æŒ‡ç¤º */}
        {voiceState.isListening && (
          <div className="mt-2 p-3 bg-green-50 border border-green-200 rounded-lg">
            <div className="flex items-center text-green-700">
              <div className="flex space-x-1 mr-3">
                <div className="w-2 h-2 bg-green-500 rounded-full animate-bounce"></div>
                <div className="w-2 h-2 bg-green-500 rounded-full animate-bounce" style={{animationDelay: '0.1s'}}></div>
                <div className="w-2 h-2 bg-green-500 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
              </div>
              <span className="text-sm font-medium">æ­£åœ¨è†å¬...è¯·å¼€å§‹è¯´è¯</span>
            </div>
            {voiceState.transcript && (
              <div className="mt-2 text-sm text-green-600">
                è¯†åˆ«ä¸­: "{voiceState.transcript}"
              </div>
            )}
          </div>
        )}

        {/* æƒé™ç­‰å¾…æŒ‡ç¤º */}
        {voiceState.waitingForPermission && (
          <div className="mt-2 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
            <div className="flex items-center text-yellow-700">
              <div className="flex space-x-1 mr-3">
                <div className="w-2 h-2 bg-yellow-500 rounded-full animate-pulse"></div>
                <div className="w-2 h-2 bg-yellow-500 rounded-full animate-pulse" style={{animationDelay: '0.2s'}}></div>
                <div className="w-2 h-2 bg-yellow-500 rounded-full animate-pulse" style={{animationDelay: '0.4s'}}></div>
              </div>
              <span className="text-sm font-medium">ç­‰å¾…æƒé™ç¡®è®¤...</span>
            </div>
          </div>
        )}

        {/* é”™è¯¯æç¤º */}
        {voiceError && (
          <div className="mt-2 p-3 bg-red-50 border border-red-200 rounded-lg">
            <div className="flex justify-between items-start">
              <div className="flex-1">
                <div className="text-sm text-red-700 whitespace-pre-wrap">{voiceError}</div>
              </div>
              <div className="flex space-x-2 ml-3">
                <button
                  onClick={onClearVoiceError}
                  className="text-xs text-red-600 hover:text-red-800 px-2 py-1"
                >
                  å¿½ç•¥
                </button>
                <button
                  onClick={onMobileQuickTest}
                  className="text-xs bg-red-100 text-red-700 px-2 py-1 rounded hover:bg-red-200"
                >
                  é‡è¯•
                </button>
              </div>
            </div>
          </div>
        )}

        {/* è°ƒè¯•ä¿¡æ¯ */}
        {process.env.NODE_ENV === 'development' && debugInfo && (
          <div className="mt-2 text-xs text-gray-600 bg-gray-100 p-2 rounded">
            <div>è°ƒè¯•ä¿¡æ¯:</div>
            <div>å¹³å°: {platformProps.isMobile ? "ç§»åŠ¨ç«¯" : "æ¡Œé¢ç«¯"}</div>
            <div>çŠ¶æ€: {voiceState.status} | ç›‘å¬: {voiceState.isListening ? 'æ˜¯' : 'å¦'}</div>
            <div>æŒ‰å‹: {isPressing ? 'æ˜¯' : 'å¦'} | æƒé™: {voiceState.permissionState}</div>
            <div>æ”¯æŒçº§åˆ«: {voiceState.supportLevel}</div>
            {voiceState.transcript && <div>è¯†åˆ«æ–‡æœ¬: "{voiceState.transcript}"</div>}
            {debugInfo}
          </div>
        )}
      </div>

      {/* çŸ¥è¯†ç‚¹ä¿å­˜æ¨¡æ€æ¡† */}
      {savingMessage && (
        <KnowledgeSaveModal
          message={savingMessage}
          onSave={handleKnowledgeSave}
          onClose={() => setSavingMessage(null)}
        />
      )}
    </div>
  );
};

export default ChatTabBase;