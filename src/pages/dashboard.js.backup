// src/pages/dashboard.js - ä½¿ç”¨è‡ªå®šä¹‰ useSession çš„ç‰ˆæœ¬
import { useState, useEffect, useCallback, useMemo } from 'react';
import { useRouter } from 'next/router';
import { useSession } from '../hooks/useSession';
import DashboardLayout from '../components/DashboardLayout';
import Head from 'next/head';

// ç®€å•çš„æ ‡ç­¾é¡µå†…å®¹ç»„ä»¶
const TabContent = ({ tabId, user }) => {
  const content = {
    overview: {
      title: 'æ¦‚è§ˆ',
      content: 'æ¬¢è¿ä½¿ç”¨ AI é¡¹ç›®å¹³å°æ§åˆ¶é¢æ¿'
    },
    projects: {
      title: 'é¡¹ç›®ç®¡ç†', 
      content: 'åœ¨è¿™é‡Œç®¡ç†æ‚¨çš„é¡¹ç›®'
    },
    chat: {
      title: 'AI å¯¹è¯',
      content: 'ä¸ AI åŠ©æ‰‹è¿›è¡Œå¯¹è¯'
    },
    knowledge: {
      title: 'çŸ¥è¯†åº“',
      content: 'ç®¡ç†æ‚¨çš„çŸ¥è¯†åº“å†…å®¹'
    },
    settings: {
      title: 'è®¾ç½®',
      content: 'è´¦æˆ·å’Œç³»ç»Ÿè®¾ç½®'
    }
  };

  const currentTab = content[tabId] || content.overview;

  return (
    <div className="p-6 bg-white rounded-lg shadow">
      <h2 className="text-2xl font-semibold mb-4">{currentTab.title}</h2>
      <div className="space-y-4">
        <p>{currentTab.content}</p>
        <div className="p-4 bg-blue-50 border border-blue-200 rounded">
          <p className="text-blue-700">
            <strong>ç”¨æˆ·ä¿¡æ¯:</strong> {user?.name} ({user?.email})
          </p>
          <p className="text-blue-600 text-sm mt-1">
            è§’è‰²: {user?.role} | ID: {user?.id}
          </p>
        </div>
      </div>
    </div>
  );
};

export default function Dashboard() {
  const router = useRouter();
  const { data: session, loading, error, authenticated, user } = useSession();
  
  const [activeTab, setActiveTab] = useState('overview');
  const [isClient, setIsClient] = useState(false);

  // å®‰å…¨çš„å®¢æˆ·ç«¯æ£€æµ‹
  useEffect(() => {
    setIsClient(true);
  }, []);

  // å®‰å…¨çš„æ ‡ç­¾é¡µåˆå§‹åŒ–
  useEffect(() => {
    if (isClient && router.query.tab) {
      const tab = router.query.tab.toString();
      if (['overview', 'projects', 'chat', 'knowledge', 'settings'].includes(tab)) {
        setActiveTab(tab);
      }
    }
  }, [router.query.tab, isClient]);

  // æ ‡ç­¾é¡µåˆ‡æ¢å¤„ç†
  const handleTabChange = useCallback((tab) => {
    if (!isClient) return;
    
    setActiveTab(tab);
    
    try {
      const newUrl = new URL(window.location.href);
      newUrl.searchParams.set('tab', tab);
      window.history.replaceState({}, '', newUrl);
    } catch (error) {
      console.warn('URLæ›´æ–°å¤±è´¥:', error);
    }
  }, [isClient]);

  // å®‰å…¨çš„ç”¨æˆ·æ•°æ®
  const currentUser = useMemo(() => {
    try {
      if (!user) {
        return createSafeUser('no-user-data');
      }

      const safeUser = {
        id: String(user.id || 'unknown'),
        name: String(user.name || 'ç”¨æˆ·'),
        email: String(user.email || ''),
        image: user.image || null,
        role: String(user.role || 'USER'),
        isAuthenticated: authenticated
      };

      return safeUser;

    } catch (err) {
      console.error('è·å–ç”¨æˆ·æ•°æ®æ—¶å‡ºé”™:', err);
      return createSafeUser('error');
    }
  }, [user, authenticated]);

  // åˆ›å»ºå®‰å…¨çš„ç”¨æˆ·å¯¹è±¡è¾…åŠ©å‡½æ•°
  const createSafeUser = (reason = 'default') => ({
    id: `safe-${reason}-${Date.now()}`,
    name: 'ç”¨æˆ·',
    email: '',
    image: null,
    role: 'USER',
    isAuthenticated: false,
    _safeReason: reason
  });

  // é¡µé¢æ ‡é¢˜
  const pageTitle = useMemo(() => {
    const titles = {
      overview: 'æ¦‚è§ˆ',
      projects: 'é¡¹ç›®',
      chat: 'AIå¯¹è¯',
      knowledge: 'çŸ¥è¯†åº“',
      settings: 'è®¾ç½®'
    };
    const tabTitle = titles[activeTab] || 'æ§åˆ¶å°';
    return `${tabTitle} - AIé¡¹ç›®å¹³å°`;
  }, [activeTab]);

  // è®¤è¯çŠ¶æ€æ£€æŸ¥
  useEffect(() => {
    if (!isClient) return;

    if (!loading && !authenticated) {
      console.log('ğŸ” æœªè®¤è¯ç”¨æˆ·ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ');
      const currentPath = window.location.pathname + window.location.search;
      const redirectUrl = `/auth/signin?callbackUrl=${encodeURIComponent(currentPath)}`;
      router.replace(redirectUrl);
      return;
    }
  }, [authenticated, loading, router, isClient]);

  // å¤„ç†é‡è¯•
  const handleRetry = useCallback(() => {
    window.location.reload();
  }, []);

  // å¤„ç†è¿”å›ç™»å½•é¡µ
  const handleBackToLogin = useCallback(() => {
    router.push('/auth/signin');
  }, [router]);

  // åŠ è½½çŠ¶æ€
  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
          <p className="mt-4 text-gray-600">éªŒè¯ç”¨æˆ·ä¼šè¯...</p>
        </div>
      </div>
    );
  }

  // é”™è¯¯çŠ¶æ€
  if (error && !authenticated) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4">
        <div className="bg-white rounded-lg shadow-lg p-8 max-w-md w-full text-center">
          <div className="text-red-500 text-6xl mb-4">âš ï¸</div>
          <h2 className="text-xl font-semibold text-gray-900 mb-2">è®¤è¯å¤±è´¥</h2>
          <p className="text-gray-600 mb-6">æ— æ³•éªŒè¯æ‚¨çš„ç™»å½•çŠ¶æ€ï¼Œè¯·é‡æ–°ç™»å½•</p>
          <div className="space-y-3">
            <button
              onClick={handleRetry}
              className="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium"
            >
              é‡è¯•
            </button>
            <button
              onClick={handleBackToLogin}
              className="w-full bg-gray-600 text-white py-3 rounded-lg hover:bg-gray-700 transition-colors font-medium"
            >
              è¿”å›ç™»å½•é¡µ
            </button>
          </div>
        </div>
      </div>
    );
  }

  // æœªè®¤è¯çŠ¶æ€
  if (!authenticated) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4">
        <div className="bg-white rounded-lg shadow-lg p-8 max-w-md w-full text-center">
          <div className="text-red-500 text-6xl mb-4">ğŸ”</div>
          <h2 className="text-xl font-semibold text-gray-900 mb-2">éœ€è¦ç™»å½•</h2>
          <p className="text-gray-600 mb-6">è¯·å…ˆç™»å½•ä»¥è®¿é—®ä»ªè¡¨æ¿</p>
          <button
            onClick={handleBackToLogin}
            className="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium"
          >
            å»ç™»å½•
          </button>
        </div>
      </div>
    );
  }

  // ä¸»æ¸²æŸ“
  return (
    <>
      <Head>
        <title>{pageTitle}</title>
        <meta name="description" content="AIé¡¹ç›®å¹³å°æ§åˆ¶é¢æ¿" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
      </Head>

      <DashboardLayout 
        user={currentUser}
        activeTab={activeTab}
        setActiveTab={handleTabChange}
        onLogout={() => {}} // åœ¨ DashboardLayout ä¸­å·²ç»å¤„ç†
      >
        <TabContent tabId={activeTab} user={currentUser} />
      </DashboardLayout>
    </>
  );
}

// ç¦ç”¨æœåŠ¡å™¨ç«¯é¢„æ¸²æŸ“
export async function getServerSideProps() {
  return {
    props: {},
  };
}