/** @type {import('next').NextConfig} */
const nextConfig = {
  // ğŸ”§ å…³é”®ä¿®å¤ï¼šç§»é™¤ output: 'standalone'ï¼Œå› ä¸ºå®ƒä¸ next start ä¸å…¼å®¹
  // output: 'standalone', // æ³¨é‡Šæ‰è¿™è¡Œ
  
  // åŸºç¡€é…ç½®
  trailingSlash: false,
  reactStrictMode: false,
  poweredByHeader: false,
  
  // å›¾ç‰‡é…ç½®
  images: {
    domains: [
      'localhost',
      '127.0.0.1', 
      '43.228.124.126',
      '191413.ai'
    ],
    unoptimized: process.env.NODE_ENV === 'development',
    // ğŸ”§ æ–°å¢ï¼šç¦ç”¨å›¾ç‰‡ä¼˜åŒ–è­¦å‘Š
    dangerouslyAllowSVG: true,
    contentDispositionType: 'attachment',
    contentSecurityPolicy: "default-src 'self'; script-src 'none'; sandbox;",
  },
  
  // æ„å»ºé…ç½®
  eslint: {
    ignoreDuringBuilds: true,
  },
  typescript: {
    ignoreBuildErrors: true,
  },
  
  // å®éªŒæ€§åŠŸèƒ½ - é’ˆå¯¹ Next.js 15 ä¼˜åŒ–
  experimental: {
    optimizeCss: true,
    // ğŸ”§ æ–°å¢ï¼šä¼˜åŒ– bundle å¤§å°
    optimizePackageImports: ['lucide-react', 'react-icons'],
    // ğŸ”§ æ–°å¢ï¼šç¦ç”¨é¢„åŠ è½½ç›¸å…³åŠŸèƒ½
    staleTimes: {
      dynamic: 0,      // ç¦ç”¨åŠ¨æ€è·¯ç”±çš„é¢„åŠ è½½
      static: 0,       // ç¦ç”¨é™æ€é¡µé¢çš„é¢„åŠ è½½
    },
    // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„é…ç½®åç§°
    serverExternalPackages: ['bcryptjs', 'jsonwebtoken'],
  },
  
  // ğŸ”§ å…³é”®ä¿®å¤ï¼šç®€åŒ–ç¯å¢ƒå˜é‡é…ç½®
  env: {
    NEXT_PUBLIC_APP_URL: process.env.NEXTAUTH_URL || 'https://191413.ai',
    // ğŸ”§ æ–°å¢ï¼šæ·»åŠ æ„å»ºæ—¶é—´æˆ³ç”¨äºç¼“å­˜æ§åˆ¶
    NEXT_PUBLIC_BUILD_TIME: new Date().toISOString(),
    // ğŸ”§ æ–°å¢ï¼šç¦ç”¨é¢„åŠ è½½æ ‡å¿—
    NEXT_PUBLIC_DISABLE_PRELOAD: 'true',
  },
  
  // ğŸ”§ å…³é”®ä¿®å¤ï¼šç®€åŒ–é‡å®šå‘ï¼Œé¿å…å¾ªç¯
  async redirects() {
    return [
      {
        source: '/home',
        destination: '/',
        permanent: true,
      },
      // ğŸ”§ æ–°å¢ï¼šä¿æŠ¤æ€§é‡å®šå‘ï¼Œé¿å…æœªè®¤è¯è®¿é—®
      {
        source: '/api/auth/error',
        destination: '/auth/signin',
        permanent: false,
      },
      // ğŸ”§ æ–°å¢ï¼šé˜»æ­¢é¢„åŠ è½½æ•°æ®çš„é‡å®šå‘
      {
        source: '/_next/data/:path*/dashboard.json',
        destination: '/auth/signin',
        permanent: false,
        has: [
          {
            type: 'query',
            key: 'callbackUrl',
            value: '/dashboard',
          }
        ]
      },
    ];
  },
  
  // ğŸ”§ å…³é”®ä¿®å¤ï¼šç®€åŒ–çš„ Webpack é…ç½®
  webpack: (config, { isServer, dev, buildId }) => {
    // ä¸ºå®¢æˆ·ç«¯ä»£ç æä¾›å¿…è¦çš„ polyfill
    if (!isServer) {
      config.resolve.fallback = {
        fs: false,
        net: false,
        tls: false,
        crypto: require.resolve('crypto-browserify'),
        stream: require.resolve('stream-browserify'),
        path: require.resolve('path-browserify'),
        os: require.resolve('os-browserify/browser'),
        http: require.resolve('stream-http'),
        https: require.resolve('https-browserify'),
        zlib: require.resolve('browserify-zlib'),
      };
    }

    // ğŸ”§ æ–°å¢ï¼šå¼€å‘ç¯å¢ƒä¼˜åŒ–
    if (dev) {
      config.watchOptions = {
        poll: 1000,
        aggregateTimeout: 300,
      };
    }

    // ğŸ”§ æ–°å¢ï¼šç”Ÿäº§ç¯å¢ƒç¦ç”¨é¢„åŠ è½½ä¼˜åŒ–
    if (!dev && !isServer) {
      // ç¦ç”¨æŸäº›å¯èƒ½å¯¼è‡´é¢„åŠ è½½çš„ä¼˜åŒ–
      config.optimization = {
        ...config.optimization,
        // å‡å°‘ä»£ç åˆ†å‰²ï¼Œé¿å…é¢„åŠ è½½
        splitChunks: {
          chunks: 'all',
          cacheGroups: {
            default: false,
            vendors: false,
            // åªå¯¹å¤§çš„åº“è¿›è¡Œä»£ç åˆ†å‰²
            commons: {
              name: 'commons',
              chunks: 'all',
              minChunks: 2,
              reuseExistingChunk: true,
            },
          },
        },
      };
    }

    return config;
  },
  
  // ç¼–è¯‘é…ç½®
  compiler: {
    removeConsole: process.env.NODE_ENV === 'production' ? {
      exclude: ['error', 'warn'],
    } : false,
    // ğŸ”§ æ–°å¢ï¼šä¼˜åŒ–æ ·å¼ç»„ä»¶
    reactRemoveProperties: process.env.NODE_ENV === 'production' ? {
      properties: ['^data-testid$'],
    } : false,
  },
  
  // ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–
  compress: true,
  
  // ğŸ”§ å…³é”®ä¿®å¤ï¼šç®€åŒ–çš„ headers é…ç½®
  async headers() {
    return [
      {
        source: '/:path*',
        headers: [
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff'
          },
          {
            key: 'X-Frame-Options', 
            value: 'DENY'
          },
          {
            key: 'X-XSS-Protection',
            value: '1; mode=block'
          },
          {
            key: 'Referrer-Policy',
            value: 'strict-origin-when-cross-origin'
          },
          // ğŸ”§ ä¿®æ”¹ï¼šæ›´ä¸¥æ ¼çš„ç¼“å­˜æ§åˆ¶
          {
            key: 'Cache-Control',
            value: 'public, max-age=0, must-revalidate'
          },
        ],
      },
      // ğŸ”§ æ–°å¢ï¼šAPI è·¯ç”±çš„ç‰¹æ®Šå¤´
      {
        source: '/api/:path*',
        headers: [
          {
            key: 'Cache-Control',
            value: 'public, max-age=0, must-revalidate'
          },
          {
            key: 'Access-Control-Allow-Origin',
            value: process.env.NEXTAUTH_URL || 'https://191413.ai'
          },
          {
            key: 'Access-Control-Allow-Methods',
            value: 'GET, POST, PUT, DELETE, OPTIONS'
          },
          {
            key: 'Access-Control-Allow-Headers',
            value: 'X-Requested-With, Content-Type, Authorization'
          },
        ],
      },
      // ğŸ”§ æ–°å¢ï¼šé™æ€èµ„æºç¼“å­˜
      {
        source: '/_next/static/:path*',
        headers: [
          {
            key: 'Cache-Control',
            value: 'public, max-age=31536000, immutable'
          },
        ],
      },
      // ğŸ”§ æ–°å¢ï¼šé˜»æ­¢é¢„åŠ è½½æ•°æ®çš„ç¼“å­˜
      {
        source: '/_next/data/:path*',
        headers: [
          {
            key: 'Cache-Control',
            value: 'public, max-age=0, must-revalidate'
          },
          {
            key: 'X-No-Preload',
            value: 'true'
          },
        ],
      },
      // ğŸ”§ æ–°å¢ï¼šå­—ä½“å’Œå›¾ç‰‡ç¼“å­˜
      {
        source: '/(.*)\\.(ico|png|jpg|jpeg|gif|webp|svg)',
        headers: [
          {
            key: 'Cache-Control',
            value: 'public, max-age=86400, stale-while-revalidate=604800'
          },
        ],
      },
    ];
  },

  // ğŸ”§ æ–°å¢ï¼šé¡µé¢é…ç½®æ‰©å±•
  pageExtensions: ['js', 'jsx', 'ts', 'tsx', 'md', 'mdx'],
  
  // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„é…ç½®åç§°
  },

  // ğŸ”§ æ–°å¢ï¼šæ—¥å¿—é…ç½®
  logging: {
    fetches: {
      fullUrl: false, // ç¦ç”¨å®Œæ•´URLæ—¥å¿—ï¼Œå‡å°‘å™ªéŸ³
    },
  },

  // ğŸ”§ æ–°å¢ï¼šç”Ÿäº§ç¯å¢ƒç¦ç”¨æºåœ°å›¾
  productionBrowserSourceMaps: false,
}

// å¼€å‘ç¯å¢ƒç‰¹å®šé…ç½®
if (process.env.NODE_ENV === 'development') {
  nextConfig.images.unoptimized = true;
  
  // ğŸ”§ æ–°å¢ï¼šå¼€å‘ç¯å¢ƒä¼˜åŒ–
  nextConfig.experimental = {
    ...nextConfig.experimental,
    // å¼€å‘ç¯å¢ƒå¯ç”¨æ›´å¤šè°ƒè¯•åŠŸèƒ½
    serverActions: true,
  };
}

// ğŸ”§ æ–°å¢ï¼šç”Ÿäº§ç¯å¢ƒç‰¹å®šä¼˜åŒ–
if (process.env.NODE_ENV === 'production') {
  // ç”Ÿäº§ç¯å¢ƒç¦ç”¨å¼€å‘ç›¸å…³åŠŸèƒ½
  
  // ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–
  nextConfig.compiler = {
    ...nextConfig.compiler,
    // ç§»é™¤æ‰€æœ‰ consoleï¼ˆé™¤äº† errorï¼‰
    removeConsole: {
      exclude: ['error'],
    },
  };

  // ğŸ”§ æ–°å¢ï¼šç”Ÿäº§ç¯å¢ƒå®Œå…¨ç¦ç”¨é¢„åŠ è½½
  nextConfig.experimental = {
    ...nextConfig.experimental,
    // å®Œå…¨ç¦ç”¨é¢„åŠ è½½ç›¸å…³åŠŸèƒ½
    optimizeCss: true,
    optimizePackageImports: ['lucide-react', 'react-icons'],
    serverExternalPackages: ['bcryptjs', 'jsonwebtoken'],
    // ç¦ç”¨æ‰€æœ‰é¢„åŠ è½½
    staleTimes: {
      dynamic: 0,
      static: 0,
    },
  };
}

module.exports = nextConfig;